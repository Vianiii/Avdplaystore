name: Android 11 with Play Store - SSH Terminal & FRP

on:
  push:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'How long to keep emulator running (minutes)'
        required: false
        default: '360'

jobs:
  android-emulator:
    runs-on: ubuntu-latest

    env:
      AVD_NAME: android_playstore
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes || '360' }}
      VPS_IP: 159.195.6.61
      FRP_SERVER_PORT: 7000
      FRP_VERSION: 0.65.0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable KVM
        run: |
          set -e
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm 2>/dev/null || true
          echo "âœ… KVM enabled"

      - name: Check /mnt Space
        run: |
          set -e
          echo "=== Storage Information ==="
          df -h /mnt
          echo ""
          
          sudo mkdir -p /mnt/android-sdk-data
          sudo chown -R runner:runner /mnt/android-sdk-data 2>/dev/null || true
          
          echo "âœ… /mnt configured"

      - name: Install x86_64 System Image with Play Store
        run: |
          set -e
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          
          echo "Installing base tools..."
          yes | sdkmanager --licenses || true
          sdkmanager --install "emulator" "platform-tools" "build-tools;34.0.0"
          
          echo "Installing Google Play Store system image..."
          sdkmanager --install "system-images;android-30;google_apis_playstore;x86_64"
          
          echo "âœ… System image installed"

      - name: Create AVD on /mnt with Play Store
        run: |
          set -e
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          
          sudo mkdir -p /mnt/android-home/.android/avd
          sudo chown -R runner:runner /mnt/android-home
          
          AVD_HOME=/mnt/android-home/.android/avd
          AVD_NAME=${{ env.AVD_NAME }}
          
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=$AVD_HOME
          
          echo "Creating AVD with Play Store..."
          echo no | avdmanager create avd \
            --force \
            --name "$AVD_NAME" \
            --package "system-images;android-30;google_apis_playstore;x86_64" \
            --device "pixel_xl"
          
          sleep 3
          
          AVD_DIR="$AVD_HOME/$AVD_NAME.avd"
          
          if [ ! -d "$AVD_DIR" ]; then
            echo "âŒ AVD creation failed"
            exit 1
          fi
          
          echo "âœ… AVD created at $AVD_DIR"
          
          # Configure Play Store and performance settings
          cat >> "$AVD_DIR/config.ini" << 'CONFEND'
          PlayStore.enabled = true
          tag.display = Google Play
          tag.id = google_apis_playstore
          hw.ramSize=12288
          hw.arch=x86_64
          hw.cpu.model=qemu64
          disk.dataPartition.size=40960m
          hw.gpu.mode=auto
          hw.gpu.enabled=yes
          hw.accelerometer=yes
          hw.gps=yes
          hw.battery=yes
          hw.audioInput=yes
          hw.audioOutput=yes
          hw.keyboard=yes
          hw.mainKeys=no
          hw.lcd.density=440
          hw.initialOrientation=portrait
          CONFEND
          
          echo "âœ… Configuration: 12GB RAM, 40GB storage, Play Store enabled"

      - name: Download FRP Client
        run: |
          set -e
          mkdir -p /tmp/frp
          cd /tmp/frp
          
          echo "Downloading FRP v${{ env.FRP_VERSION }}..."
          wget -q https://github.com/fatedier/frp/releases/download/v${{ env.FRP_VERSION }}/frp_${{ env.FRP_VERSION }}_linux_amd64.tar.gz
          tar -xzf frp_${{ env.FRP_VERSION }}_linux_amd64.tar.gz
          
          echo "âœ… FRP downloaded"

      - name: Configure FRP Client
        run: |
          set -e
          cat > /tmp/frp/frpc.toml << 'FRPCONF'
          serverAddr = "159.195.6.61"
          serverPort = 7000
          
          [[proxies]]
          name = "adb-emulator"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5555
          remotePort = 5555
          
          [[proxies]]
          name = "ssh-terminal"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 22
          remotePort = 2222
          FRPCONF
          
          echo "âœ… FRP client configured"

      - name: Start Emulator
        run: |
          set -e
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=/mnt/android-home/.android/avd
          export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
          
          AVD_NAME=${{ env.AVD_NAME }}
          
          echo "Starting emulator with Play Store..."
          nohup emulator -avd "$AVD_NAME" \
            -no-window \
            -no-audio \
            -no-snapshot \
            -accel on \
            -no-metrics \
            -netdelay none \
            -netspeed full \
            > /tmp/emulator.log 2>&1 &
          
          PID=$!
          echo "Emulator PID: $PID"
          sleep 45
          
          adb kill-server 2>/dev/null || true
          sleep 2
          adb start-server
          sleep 5
          
          echo "Waiting for emulator boot..."
          SUCCESS=0
          
          for i in {1..180}; do
            if adb devices | grep -q "device$"; then
              echo "âœ… Emulator booted! (${i}s)"
              SUCCESS=1
              break
            fi
            
            if ! kill -0 $PID 2>/dev/null; then
              echo "âŒ Emulator crashed"
              tail -30 /tmp/emulator.log
              exit 1
            fi
            
            if [ $((i % 30)) -eq 0 ]; then
              echo "â³ Boot progress: ${i}/180s..."
            fi
            
            sleep 1
          done
          
          if [ $SUCCESS -eq 0 ]; then
            echo "âŒ Boot timeout"
            tail -30 /tmp/emulator.log
            exit 1
          fi
          
          sleep 15

      - name: Authorize ADB for Remote Access (No Auth Required)
        run: |
          set -e
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          
          echo "Setting up ADB for unauthenticated remote access..."
          
          # Generate ADB keys
          mkdir -p ~/.android
          if [ ! -f ~/.android/adbkey ]; then
            echo "no" | adb keygen ~/.android/adbkey
          fi
          
          # Create authorized_keys on emulator
          adb shell mkdir -p /data/misc/adb
          adb shell rm -f /data/misc/adb/adb_keys
          
          # Push public key
          adb push ~/.android/adbkey.pub /data/misc/adb/adb_keys
          adb shell chmod 644 /data/misc/adb/adb_keys
          
          # Verify
          adb shell ls -la /data/misc/adb/adb_keys
          
          echo "Enabling ADB over TCP (unauthenticated)..."
          adb tcpip 5555
          sleep 3
          
          # Test local TCP connection
          adb connect 127.0.0.1:5555
          sleep 2
          
          echo "âœ… ADB authorized for remote access - NO AUTHENTICATION NEEDED"
          adb devices

      - name: Start FRP Client
        run: |
          set -e
          cd /tmp/frp/frp_${{ env.FRP_VERSION }}_linux_amd64
          
          echo "Starting FRP client..."
          nohup ./frpc -c /tmp/frp/frpc.toml > /tmp/frpc.log 2>&1 &
          
          FRPC_PID=$!
          echo "FRP Client PID: $FRPC_PID"
          sleep 3
          
          if ! kill -0 $FRPC_PID 2>/dev/null; then
            echo "âŒ FRP client failed to start"
            cat /tmp/frpc.log
            exit 1
          fi
          
          echo "âœ… FRP client started"

      - name: Verify Setup
        run: |
          set -e
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          
          echo ""
          echo "========================================="
          echo "âœ… VERIFICATION PASSED"
          echo "========================================="
          echo ""
          
          echo "ðŸ“± Connected Devices:"
          adb devices
          echo ""
          
          echo "ðŸ“Š Emulator Properties:"
          adb shell getprop ro.build.version.release
          adb shell getprop ro.build.version.sdk
          echo ""

      - name: Setup Persistent tmate Session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false
          connect-timeout-seconds: 120
          timeout-minutes: 360

      - name: Monitor and Keep Running (Persistent tmate)
        run: |
          set -e
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=/mnt/android-home/.android/avd
          export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
          
          RUNTIME_SECONDS=$(((${{ env.RUNTIME_MINUTES }}) * 60))
          HOURS=$(((${{ env.RUNTIME_MINUTES }}) / 60))
          MINS=$(((${{ env.RUNTIME_MINUTES }}) % 60))
          END_TIME=$(($(date +%s) + RUNTIME_SECONDS))
          
          echo ""
          echo "========================================="
          echo "âœ… Android 11 with Play Store - READY"
          echo "========================================="
          echo ""
          echo "ðŸ“Š Configuration:"
          echo "  â€¢ OS: Android 11 (API 30)"
          echo "  â€¢ Architecture: x86_64"
          echo "  â€¢ RAM: 12 GB | Storage: 40 GB (/mnt)"
          echo "  â€¢ Play Store: âœ… ENABLED"
          echo ""
          echo "ðŸŒ REMOTE CONNECTION (NO AUTHENTICATION REQUIRED):"
          echo ""
          echo "1ï¸âƒ£  ADB DIRECT CONNECTION:"
          echo "   adb connect 159.195.6.61:5555"
          echo "   adb devices"
          echo "   adb shell"
          echo ""
          echo "2ï¸âƒ£  SSH TERMINAL:"
          echo "   ssh -p 2222 runner@159.195.6.61"
          echo ""
          echo "3ï¸âƒ£  PERSISTENT TMATE SESSION:"
          echo "   ssh token@nyc1.tmate.io"
          echo "   (You're currently in it - can reconnect anytime)"
          echo ""
          echo "â±ï¸  Runtime: $HOURS hours $MINS minutes"
          echo "Start: $(date)"
          echo "End: $(date -d "+$HOURS hours +$MINS minutes")"
          echo "========================================="
          echo ""
          
          CHECK_INTERVAL=30
          
          while [ $(date +%s) -lt $END_TIME ]; do
            REMAINING=$((END_TIME - $(date +%s)))
            REMAINING_MINS=$((REMAINING / 60))
            REMAINING_SECS=$((REMAINING % 60))
            
            # Check ADB connection
            if adb devices 2>/dev/null | grep -q "emulator-5554"; then
              STATUS="âœ… Emulator"
            elif adb devices 2>/dev/null | grep -q "device$"; then
              STATUS="âœ… TCP Remote"
            else
              STATUS="âš ï¸  Offline"
              pkill -f "emulator" || true
              sleep 5
              
              nohup emulator -avd ${{ env.AVD_NAME }} \
                -no-window -no-audio -no-snapshot -accel on \
                > /tmp/emulator.log 2>&1 &
              
              sleep 45
              adb kill-server 2>/dev/null || true
              sleep 2
              adb start-server
              sleep 5
              
              for i in {1..120}; do
                if adb devices 2>/dev/null | grep -q "device$"; then
                  adb tcpip 5555
                  STATUS="âœ… Recovered"
                  break
                fi
                sleep 1
              done
            fi
            
            # Check FRP
            if pgrep -f "frpc" > /dev/null; then
              FRP_STATUS="âœ…"
            else
              FRP_STATUS="âŒ"
            fi
            
            # Check tmate
            if pgrep -f "tmate" > /dev/null; then
              TMATE_STATUS="âœ…"
            else
              TMATE_STATUS="âŒ"
            fi
            
            echo "[$(date '+%H:%M:%S')] ADB: $STATUS | FRP: $FRP_STATUS | tmate: $TMATE_STATUS | Remaining: ${REMAINING_MINS}m"
            
            sleep $CHECK_INTERVAL
          done
          
          echo ""
          echo "========================================="
          echo "â±ï¸  Runtime completed"
          echo "========================================="

      - name: Collect Debug Logs
        if: always()
        run: |
          mkdir -p debug_logs
          
          {
            echo "=== Time ==="
            date
            echo ""
            echo "=== System Info ==="
            uname -a
            echo ""
            echo "=== Processes ==="
            ps aux | grep -E "emulator|qemu|frpc|tmate" || echo "No processes"
            echo ""
            echo "=== ADB Status ==="
            adb devices 2>/dev/null || echo "ADB unavailable"
            echo ""
            echo "=== /mnt Usage ==="
            du -sh /mnt/* 2>/dev/null || echo "No info"
          } > debug_logs/system-info.txt
          
          ls -lah debug_logs/

      - name: Cleanup
        if: always()
        run: |
          set +e
          pkill -f "emulator" || true
          pkill -f "frpc" || true
          pkill -9 qemu-system || true
          sleep 2
          echo "âœ… Cleanup done"

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-session-${{ github.run_number }}
          path: |
            /tmp/emulator.log
            /tmp/frpc.log
            debug_logs/
          retention-days: 3
