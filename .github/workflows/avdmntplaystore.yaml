name: Android 11 Play Store - Persistent Emulator with FRP & tmate

on:
  push:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'Session duration in minutes (5-1440)'
        required: false
        default: '360'

jobs:
  android-emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 1440

    env:
      AVD_NAME: android_playstore
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes || '360' }}
      VPS_IP: 159.195.6.61
      FRP_VERSION: 0.65.0
      ANDROID_EMULATOR_USE_SYSTEM_LIBS: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable KVM & GPU Acceleration
        run: |
          set -e
          echo "Setting up KVM..."
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm 2>/dev/null || true
          echo "âœ… KVM enabled"

      - name: Setup Storage on /mnt
        run: |
          set -e
          echo "=== Storage Information ==="
          df -h /mnt
          
          sudo mkdir -p /mnt/android-home/.android/avd
          sudo chown -R runner:runner /mnt/android-home
          chmod 777 /mnt/android-home
          
          echo "âœ… Storage configured on /mnt"

      - name: Install Dependencies
        run: |
          set -e
          echo "Installing system dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            libvulkan1 vulkan-tools mesa-vulkan-drivers \
            libxkbcommon-x11-0 libdbus-1-3 \
            xvfb x11-utils libssl-dev
          echo "âœ… Dependencies installed"

      - name: Install Android System Image with Play Store
        run: |
          set -e
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          
          echo "Accepting SDK licenses..."
          yes | sdkmanager --licenses > /dev/null 2>&1 || true
          
          echo "Installing emulator and tools..."
          sdkmanager --install \
            "emulator" \
            "platform-tools" \
            "build-tools;34.0.0" > /dev/null 2>&1
          
          echo "Installing Google Play Store system image..."
          sdkmanager --install "system-images;android-30;google_apis_playstore;x86_64" > /dev/null 2>&1
          
          echo "âœ… System image installed"

      - name: Create AVD with Play Store
        run: |
          set -e
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=/mnt/android-home/.android/avd
          
          AVD_NAME=${{ env.AVD_NAME }}
          AVD_DIR=$ANDROID_AVD_HOME/$AVD_NAME.avd
          
          echo "Creating AVD: $AVD_NAME"
          echo "no" | avdmanager create avd \
            --force \
            --name "$AVD_NAME" \
            --package "system-images;android-30;google_apis_playstore;x86_64" \
            --device "pixel_xl" > /dev/null 2>&1
          
          sleep 2
          
          if [ ! -d "$AVD_DIR" ]; then
            echo "âŒ AVD creation failed"
            exit 1
          fi
          
          echo "Configuring AVD performance..."
          cat >> $AVD_DIR/config.ini << 'EOF'
          PlayStore.enabled = true
          tag.display = Google Play
          tag.id = google_apis_playstore
          hw.ramSize=12288
          hw.arch=x86_64
          hw.cpu.model=qemu64
          hw.cpu.ncore=4
          disk.dataPartition.size=40960m
          hw.gpu.mode=auto
          hw.gpu.enabled=yes
          hw.gles=2
          hw.accelerometer=yes
          hw.gyroscope=yes
          hw.sensors.temperature=yes
          hw.gps=yes
          hw.battery=yes
          hw.audioInput=yes
          hw.audioOutput=yes
          hw.keyboard=yes
          hw.mainKeys=no
          hw.lcd.density=440
          hw.lcd.width=1080
          hw.lcd.height=1920
          hw.initialOrientation=portrait
          hw.sensors.orientation=yes
          image.sysdir=system/
          EOF
          
          echo "âœ… AVD created at: $AVD_DIR"

      - name: Download FRP Client
        run: |
          set -e
          mkdir -p /tmp/frp
          cd /tmp/frp
          
          echo "Downloading FRP v${{ env.FRP_VERSION }}..."
          wget -q https://github.com/fatedier/frp/releases/download/v${{ env.FRP_VERSION }}/frp_${{ env.FRP_VERSION }}_linux_amd64.tar.gz
          tar -xzf frp_${{ env.FRP_VERSION }}_linux_amd64.tar.gz
          rm frp_${{ env.FRP_VERSION }}_linux_amd64.tar.gz
          
          echo "âœ… FRP downloaded"

      - name: Configure FRP Client
        run: |
          set -e
          cat > /tmp/frp/frpc.toml << 'EOF'
          [common]
          server_addr = "159.195.6.61"
          server_port = 7000
          token = "12345678"
          
          [[proxies]]
          name = "adb-emulator"
          type = "tcp"
          local_ip = "127.0.0.1"
          local_port = 5555
          remote_port = 5555
          
          [[proxies]]
          name = "ssh-runner"
          type = "tcp"
          local_ip = "127.0.0.1"
          local_port = 22
          remote_port = 2222
          EOF
          
          echo "âœ… FRP configured"

      - name: Start Android Emulator
        run: |
          set -e
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=/mnt/android-home/.android/avd
          export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
          
          AVD_NAME=${{ env.AVD_NAME }}
          
          echo "Starting Android emulator..."
          nohup emulator -avd "$AVD_NAME" \
            -no-window \
            -no-audio \
            -no-snapshot \
            -no-metrics \
            -accel on \
            -netdelay none \
            -netspeed full \
            -gpu auto \
            > /tmp/emulator.log 2>&1 &
          
          EMULATOR_PID=$!
          echo "Emulator PID: $EMULATOR_PID"
          sleep 50
          
          # Initialize ADB
          adb kill-server 2>/dev/null || true
          sleep 2
          adb start-server
          sleep 5
          
          echo "Waiting for emulator to boot..."
          BOOT_SUCCESS=0
          
          for i in {1..180}; do
            DEVICES=$(adb devices 2>/dev/null | grep -c "device$" || echo "0")
            
            if [ "$DEVICES" -gt 0 ]; then
              echo "âœ… Emulator booted! (${i}s)"
              BOOT_SUCCESS=1
              break
            fi
            
            if ! kill -0 $EMULATOR_PID 2>/dev/null; then
              echo "âŒ Emulator process crashed"
              tail -50 /tmp/emulator.log
              exit 1
            fi
            
            if [ $((i % 30)) -eq 0 ]; then
              echo "â³ Still booting... ${i}s elapsed"
            fi
            
            sleep 1
          done
          
          if [ $BOOT_SUCCESS -eq 0 ]; then
            echo "âŒ Emulator boot timeout"
            tail -50 /tmp/emulator.log
            exit 1
          fi
          
          sleep 20
          echo "âœ… Emulator ready"

      - name: Setup ADB Authorization (No Auth Required)
        run: |
          set -e
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          
          echo "Setting up ADB for unauthenticated remote access..."
          
          # Generate ADB keys locally
          mkdir -p ~/.android
          if [ ! -f ~/.android/adbkey ]; then
            echo "no" | adb keygen ~/.android/adbkey
            echo "âœ… ADB keys generated"
          else
            echo "âœ… ADB keys already exist"
          fi
          
          # Create directory on emulator
          echo "Preparing emulator..."
          adb shell mkdir -p /data/misc/adb
          
          # Push authorization key
          echo "Pushing ADB authorization key..."
          adb push ~/.android/adbkey.pub /data/misc/adb/adb_keys
          adb shell chmod 644 /data/misc/adb/adb_keys
          
          # Verify key
          echo "Verifying key installation..."
          adb shell ls -la /data/misc/adb/adb_keys
          
          # Enable ADB over TCP
          echo "Enabling ADB TCP mode..."
          adb tcpip 5555
          sleep 3
          
          # Verify
          echo "Connected devices:"
          adb devices
          
          echo "âœ… ADB authorization complete - NO AUTHENTICATION REQUIRED"

      - name: Start FRP Tunnel
        run: |
          set -e
          cd /tmp/frp/frp_${{ env.FRP_VERSION }}_linux_amd64
          
          echo "Starting FRP client..."
          nohup ./frpc -c /tmp/frp/frpc.toml > /tmp/frpc.log 2>&1 &
          
          FRP_PID=$!
          echo "FRP PID: $FRP_PID"
          sleep 3
          
          if ! kill -0 $FRP_PID 2>/dev/null; then
            echo "âŒ FRP failed to start"
            cat /tmp/frpc.log
            exit 1
          fi
          
          echo "âœ… FRP tunnel active"

      - name: Verify Complete Setup
        run: |
          set -e
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          
          echo ""
          echo "=========================================="
          echo "âœ… SETUP VERIFICATION"
          echo "=========================================="
          echo ""
          
          echo "ğŸ“± ADB Devices:"
          adb devices
          echo ""
          
          echo "ğŸ“Š Emulator Info:"
          adb shell getprop ro.build.version.release
          adb shell getprop ro.hardware
          echo ""
          
          echo "ğŸŒ FRP Status:"
          sleep 2
          if pgrep -f frpc > /dev/null; then
            echo "âœ… FRP tunnel running"
            tail -5 /tmp/frpc.log
          else
            echo "âŒ FRP tunnel not running"
          fi
          echo ""

      - name: Setup SSH Tunnel to Runner
        run: |
          set -e
          echo "Setting up SSH server on runner..."
          
          # SSH is already running on ubuntu-latest
          echo "âœ… SSH available on port 22"
          netstat -tuln | grep 22 || echo "SSH service info"

      - name: Open tmate Session (Interactive Terminal)
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false
          connect-timeout-seconds: 300
          timeout-minutes: 360

      - name: Keep Session & Services Running
        run: |
          set -e
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=/mnt/android-home/.android/avd
          export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
          
          RUNTIME_MINUTES=${{ env.RUNTIME_MINUTES }}
          RUNTIME_SECONDS=$((RUNTIME_MINUTES * 60))
          HOURS=$((RUNTIME_MINUTES / 60))
          MINS=$((RUNTIME_MINUTES % 60))
          END_TIME=$(($(date +%s) + RUNTIME_SECONDS))
          
          # Display connection info
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸš€ Android 11 Emulator - READY FOR REMOTE CONNECTION ğŸš€          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š EMULATOR CONFIGURATION:"
          echo "  â€¢ OS: Android 11 (API 30)"
          echo "  â€¢ Architecture: x86_64"
          echo "  â€¢ RAM: 12 GB | Storage: 40 GB"
          echo "  â€¢ Play Store: âœ… ENABLED"
          echo "  â€¢ GPU: Auto | Acceleration: On"
          echo ""
          echo "ğŸŒ REMOTE CONNECTION METHODS:"
          echo ""
          echo "1ï¸âƒ£  ADB REMOTE (No Authentication):"
          echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "   â”‚ adb connect 159.195.6.61:5555           â”‚"
          echo "   â”‚ adb devices                             â”‚"
          echo "   â”‚ adb shell                               â”‚"
          echo "   â”‚ adb install <app.apk>                   â”‚"
          echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "2ï¸âƒ£  SSH TERMINAL:"
          echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "   â”‚ ssh -p 2222 runner@159.195.6.61         â”‚"
          echo "   â”‚ (via FRP tunnel)                        â”‚"
          echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "3ï¸âƒ£  TMATE INTERACTIVE SESSION:"
          echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "   â”‚ ssh token@nyc1.tmate.io                 â”‚"
          echo "   â”‚ (Reconnect multiple times - persistent) â”‚"
          echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "â±ï¸  SESSION DURATION:"
          echo "   â€¢ Duration: $HOURS hours $MINS minutes"
          echo "   â€¢ Start: $(date)"
          echo "   â€¢ End: $(date -d "+$HOURS hours +$MINS minutes")"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    YOU CAN NOW INTERACT WITH                       â•‘"
          echo "â•‘          THE EMULATOR FROM YOUR TERMUX/LOCAL MACHINE               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Main monitoring loop
          CHECK_INTERVAL=60
          
          while [ $(date +%s) -lt $END_TIME ]; do
            REMAINING=$((END_TIME - $(date +%s)))
            REMAINING_HOURS=$((REMAINING / 3600))
            REMAINING_MINS=$(((REMAINING % 3600) / 60))
            REMAINING_SECS=$((REMAINING % 60))
            
            # Check emulator
            if adb devices 2>/dev/null | grep -q "device$"; then
              EMULATOR_STATUS="âœ… Active"
            else
              EMULATOR_STATUS="âš ï¸  Offline - Recovering"
              echo "[$(date '+%H:%M:%S')] Emulator offline, attempting recovery..."
              
              pkill -f "emulator -avd" || true
              sleep 5
              
              nohup emulator -avd ${{ env.AVD_NAME }} \
                -no-window -no-audio -no-snapshot -accel on \
                > /tmp/emulator.log 2>&1 &
              
              sleep 50
              adb kill-server 2>/dev/null || true
              sleep 2
              adb start-server
              sleep 5
              
              for i in {1..120}; do
                if adb devices 2>/dev/null | grep -q "device$"; then
                  adb tcpip 5555
                  EMULATOR_STATUS="âœ… Recovered"
                  break
                fi
                sleep 1
              done
            fi
            
            # Check FRP
            if pgrep -f "frpc" > /dev/null; then
              FRP_STATUS="âœ… Active"
            else
              FRP_STATUS="âŒ Inactive"
            fi
            
            # Check tmate
            if pgrep -f "tmate" > /dev/null; then
              TMATE_STATUS="âœ… Active"
            else
              TMATE_STATUS="âš ï¸  Idle"
            fi
            
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Emulator: $EMULATOR_STATUS | FRP: $FRP_STATUS | tmate: $TMATE_STATUS | Remaining: ${REMAINING_HOURS}h ${REMAINING_MINS}m ${REMAINING_SECS}s"
            
            sleep $CHECK_INTERVAL
          done
          
          echo ""
          echo "=========================================="
          echo "â±ï¸  Session duration completed"
          echo "=========================================="

      - name: Collect System Diagnostics
        if: always()
        run: |
          set -e
          mkdir -p debug_logs
          
          echo "Collecting diagnostic information..."
          {
            echo "=== Timestamp ==="
            date
            echo ""
            echo "=== System Information ==="
            uname -a
            echo ""
            echo "=== CPU/Memory ==="
            free -h
            echo ""
            echo "=== Storage Usage ==="
            df -h /mnt
            echo ""
            echo "=== Running Processes ==="
            ps aux | grep -E "emulator|qemu|frpc|tmate|adb" || echo "No processes"
            echo ""
            echo "=== ADB Devices ==="
            adb devices 2>/dev/null || echo "ADB unavailable"
            echo ""
            echo "=== Network Status ==="
            netstat -tuln | grep -E "5555|2222|22|7000" || echo "No tunnels"
          } > debug_logs/system-info.txt
          
          echo "âœ… Diagnostics collected"
          ls -lah debug_logs/

      - name: Cleanup & Shutdown
        if: always()
        run: |
          set +e
          echo "Cleaning up resources..."
          
          pkill -f "emulator -avd" || true
          pkill -f "frpc" || true
          pkill -9 qemu-system || true
          pkill -f "tmate" || true
          
          sleep 2
          echo "âœ… Cleanup complete"

      - name: Upload Emulator Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logs-${{ github.run_number }}
          path: |
            /tmp/emulator.log
            /tmp/frpc.log
            debug_logs/
          retention-days: 5

      - name: Upload AVD Configuration
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: avd-config-${{ github.run_number }}
          path: /mnt/android-home/.android/avd/
          retention-days: 3
